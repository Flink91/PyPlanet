language: python

dist: trusty
sudo: required

python:
  - 3.5
  - 3.6

cache:
  directories:
    - $HOME/.cache/pip

services:
  - mysql
  - postgresql

env:
  global:
    - secure: nzhTQtPHI2pgoFhyW943aEsw2qOmljMhKDIaGiHiEWuV0QwM2RQDqq4p/WDc1i1Ce3XRsjApqwIIoT0M+h9PHPJnk6s8EGsdac5hzR40F9WWx679sMMB+O15PSp4TXGIOdfEOnAsYKefWSKLjjfkcj5rhvYJS098k5x/Ft3ufyzCOQ7iRaGDKC3tPEefgOf/hsCHP8jLpReyPSf8269OFVWdmKVVIwk81MnUr45iCGM9SJCRS+SCZ3pYwH3/KXnTEbV40Vzgl5GxL8Gz2AMi7KUKKoRN8TxT36+u7J66QcCnV3DQ0o8psu8Qh9cttt/EpRGCBFps0ShJA4AKs+wfDXrZuURBRKTJyDTcaXp7+xP0bbN2z/4TS893JNoCPGR76Uvu9K19qwLISI2SvjyEXPI3kEpbUN8I7ljptK33+MgP1Yjuu+CYoOWSnnr0KbwBG/uedxEVnlAISTnuhTHYSOyQg85o2nN5jOyBY1bz6WL2Cc5CVAePhASKXBmvfQDzm8gdi0gAOQuArCoA3+f6ubjkN2nTvALqdqcmW71dKOC1trjMgbAf4O3recnxisW5vho4L2K/wyTjHFJlZBAfG+5blXwbkdDtBDVqeo6MuMWkKNN/NKSQ1hequ7vMUyYulfgdR8KvT4NeTCxd0H7jk86hUKf9QvTNazHvgICe1Us=
  matrix:
    # Unit tests.
    - TOXENV=py35-unit-mysql
    - TOXENV=py35-unit-postgresql
    - TOXENV=py36-unit-mysql
    - TOXENV=py36-unit-postgresql
    - TOXENV=py35-integration-mysql
    - TOXENV=py36-integration-mysql

matrix:
#  include:
#    - os: linux
#    - os: osx
  exclude:
    - python: 3.6
      env: TOXENV=py35-unit-mysql
    - python: 3.6
      env: TOXENV=py35-unit-postgresql
    - python: 3.6
      env: TOXENV=py35-integration-mysql
    - python: 3.6
      env: TOXENV=py35-integration-postgresql
    - python: 3.5
      env: TOXENV=py36-unit-mysql
    - python: 3.5
      env: TOXENV=py36-unit-postgresql
    - python: 3.5
      env: TOXENV=py36-integration-mysql
    - python: 3.5
      env: TOXENV=py36-integration-postgresql

  last_finish: true

before_install:
  - sleep 15
  - mysql -u root -e "CREATE DATABASE pyplanet CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
  - mysql -u root -e "SET PASSWORD FOR 'root'@'localhost' = PASSWORD('')"
  - psql -c "create database pyplanet ENCODING 'UTF8' LC_COLLATE = 'en_US.UTF-8' LC_CTYPE = 'en_US.UTF-8';" -U postgres
  - psql -c "CREATE USER pyplanet WITH PASSWORD 'pyplanet';" -U postgres

install:
  - pip install tox codacy-coverage python-coveralls -U pip
  - tests/_scripts/travis_dedicated_setup.sh

before_script:
  - tests/_scripts/travis_config.sh
  - tests/_scripts/travis_dedicated_start.sh

script:
  - tox -e $TOXENV -- --with-coverage --cover-package=pyplanet --cover-xml --cover-xml-file=coverage.xml
  - tests/_scripts/travis_build_binary.sh

after_success:
  - coveralls --ignore-errors
#  - tests/_scripts/travis_coverage.sh
#  - python-codacy-coverage -r coverage.xml

after_failure:
  - cat dedicated/Logs/*

deploy:
  provider: releases
  api_key:
    secure: jmdxPQpZOZrOgGLkls1IznIuYs43CEU+Q5GyQDGcIfOQtttOxiwgKjsCg37/1RVHylpSIqRYWVrzSlcw5k4bA9SANWjG4ENtdrG8J63LvjzAHUfzAquxwmHXpv1j+dU5heOheIgl5ckmXvWvMosddu412sEBtDtwuIwtV2v3VnYy8OV21mKg/JmCjJTZt/MurBfqgNyoMpKljIBiAuknlpKX8+Px4oxOZVR98GkmbEm5I9SxhrArr8XX8yshAyWyHPHF2ubiFUajkpl9yLrapiZwtNMJMEsvNcRFN3wL8anNJwmXVUWCRV/MXBYJpMoa31DR9YmlTYTS/QhxHhdl71y/PB2UMHcGlr+0ms5/fgiSeaBls2EIjyqd80+YIsP/lHGrjYv7BaZZEquXUHdvd51zkYfOv6YmmaZKq62pxKRAX1jyhQdwfbkkJPeqy7YjNrVT9gikbupLQecenFQ3tttbb6TOtsdDPeiDcYWW1wqpE+DoGVkludwN6YTEGkm7G+YX44PFk8aOEZJN31hibqwOXHIDUK/oiaGOMv4faftykE9Yx0YM9wJ1IjWrqw5A3Vp+A82yJ2jFHf+WK7bMAxoj0T23nIHNPuM74Bmv2KWBXWmXH/VFuMvjSeJHYzMWbUoIRe70ClSZsc8iikQkp1iZoeYaOlw3HWq21wUrh6I=
  file: dist/pyplanet
  on:
    repo: PyPlanet/PyPlanet
    tags: true
  draft: true
